# MyRAG 全能启动脚本使用说明

## 简介

`setup.bat` 是 MyRAG 项目的智能启动脚本，能够自动检测环境、安装依赖、初始化数据库，并启动服务。

---

## 特性

### ✨ 智能检测
- 🔍 自动检测 Conda 环境
- 🔍 检查 Python 依赖包
- 🔍 验证数据库连接和表结构
- 🔍 检查 Ollama 服务和模型
- 🔍 检测 CUDA/GPU 可用性
- 🔍 检查端口占用情况

### 🛠️ 自动修复
- 📦 引导创建 MyRAG 虚拟环境
- 📦 自动安装缺失的依赖
- 📦 自动创建数据库和表
- 📦 自动创建必要的目录

### 💡 友好提示
- 清晰的进度显示
- 详细的错误信息
- 具体的修复建议

---

## 使用方法

### 快速启动

双击运行 `setup.bat` 或在命令行中执行：

```bash
setup.bat
```

### 首次运行

如果是第一次运行，脚本会：

1. **检查 Conda**
   - 如果没有安装 Conda，会提示下载链接
   
2. **检查 MyRAG 环境**
   - 如果环境不存在，询问是否创建
   - 输入 `Y` 自动创建环境（Python 3.11）

3. **检查依赖**
   - 如果依赖缺失，询问是否安装
   - 输入 `Y` 自动安装所有依赖

4. **系统检查**
   - 运行完整的系统检查
   - 自动修复可修复的问题

5. **启动服务**
   - 所有检查通过后启动 FastAPI 服务

---

## 检查项说明

### 第一阶段：环境检查

#### 1. Conda 环境
- 检测 Conda 是否安装
- 检测 MyRAG 环境是否存在
- 验证 Python 版本

**失败处理**：
- 提供 Conda 安装链接
- 提供环境创建命令
- 可选择自动创建环境

#### 2. Python 依赖
- 快速检查关键包（fastapi, uvicorn, torch 等）
- 如果缺失，提供安装选项

**失败处理**：
- 询问是否安装依赖
- 使用国内镜像加速下载

### 第二阶段：系统检查 (setup.py)

#### 3. 配置文件
- 检查 `Backend/config.yaml` 是否存在
- 验证 YAML 格式是否正确
- 检查必要配置项

#### 4. MySQL 服务
- 检测 MySQL 是否运行
- 测试数据库连接
- 验证用户权限

**失败处理**：
- 提示启动 MySQL 命令
- 显示连接错误详情

#### 5. 数据库
- 检查数据库是否存在
- 自动创建缺失的数据库

#### 6. 数据表
- 检查 6 个必要的表是否存在
- 自动执行初始化脚本

**涉及的表**：
- knowledge_bases（知识库）
- files（文件）
- text_chunks（文本块）
- conversations（对话）
- messages（消息）
- intelligent_assistants（智能助手）

#### 7. 存储目录
- 检查并创建关键目录
- KnowledgeBase/（知识库文件）
- VectorDB/（向量数据库）
- logs/（日志）
- Models/（模型文件）

#### 8. Ollama 服务（可选）
- 检测 Ollama 是否运行
- 检查所需模型是否存在
- 显示模型下载命令

#### 9. CUDA/GPU
- 检测 CUDA 是否可用
- 显示 GPU 信息和显存大小
- 如果不可用，提示将使用 CPU

#### 10. 端口占用
- 检查 8000 端口（FastAPI）
- 如果被占用，显示警告

#### 11. 向量数据库
- 检查 ChromaDB 是否初始化
- 首次运行会自动创建

---

## 常见问题

### Q1: "Conda 未安装或未添加到 PATH"

**解决方法**：
1. 下载安装 Anaconda 或 Miniconda
   - Anaconda: https://www.anaconda.com/download
   - Miniconda: https://docs.conda.io/en/latest/miniconda.html
2. 安装完成后重启命令行
3. 重新运行 `setup.bat`

### Q2: "MySQL 服务未运行"

**解决方法**：
1. 启动 MySQL 服务：
   ```bash
   net start mysql80
   # 或
   net start mysql
   ```
2. 检查服务名称：
   ```bash
   sc query type= service state= all | findstr MySQL
   ```
3. 如果未安装 MySQL，请先安装

### Q3: "MySQL 用户名或密码错误"

**解决方法**：
1. 检查 `Backend/config.yaml` 中的数据库配置
2. 确认用户名和密码正确
3. 确认用户有足够的权限

### Q4: "端口 8000 已被占用"

**解决方法**：
1. 查找占用端口的进程：
   ```bash
   netstat -ano | findstr :8000
   ```
2. 终止进程：
   ```bash
   taskkill /PID <进程ID> /F
   ```
3. 或修改 `config.yaml` 使用其他端口

### Q5: "依赖安装失败"

**解决方法**：
1. 检查网络连接
2. 尝试手动安装：
   ```bash
   conda activate MyRAG
   cd Backend
   pip install -r requirements.txt
   ```
3. 使用国内镜像：
   ```bash
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
   ```

### Q6: "Ollama 服务未运行"

**说明**：Ollama 是可选服务，不影响系统运行

**解决方法**（如果需要使用 Ollama）：
1. 启动 Ollama 服务
2. 下载所需模型：
   ```bash
   ollama pull nomic-embed-text
   ollama pull deepseek-v3.1:671b-cloud
   ```

---

## 手动检查命令

如果需要单独运行检查脚本：

```bash
# 激活环境
conda activate MyRAG

# 运行检查
python setup.py

# 强制完整检查
python setup.py --full-check

# 禁用颜色输出
python setup.py --no-color
```

---

## 文件说明

- **setup.bat** - Windows 批处理启动脚本
  - 检查 Conda 环境
  - 检查和安装依赖
  - 调用 setup.py 进行高级检查
  - 启动 FastAPI 服务

- **setup.py** - Python 检查脚本
  - 配置文件验证
  - 数据库检查和初始化
  - 外部服务检查
  - 硬件检查

---

## 与其他启动脚本的区别

| 脚本 | 特点 | 适用场景 |
|------|------|----------|
| **setup.bat** | 完整检查+自动修复 | 首次运行、环境问题排查 |
| **start-fast.bat** | 快速启动 | 日常使用、环境已配置好 |
| **start.bat** | 标准启动+依赖检查 | 正常使用 |

### 推荐使用流程

1. **首次使用**：运行 `setup.bat` 完成初始化
2. **日常使用**：运行 `start-fast.bat` 快速启动
3. **遇到问题**：运行 `setup.bat` 诊断修复

---

## 日志和缓存

- **启动缓存**: `.startup_cache.json`
  - 缓存检查结果，加速后续启动
  - 删除此文件会强制完整检查

- **日志文件**: `logs/`
  - 记录系统运行日志
  - 便于问题追踪

---

## 技术支持

如果遇到脚本无法解决的问题：

1. 查看 `logs/` 目录下的日志文件
2. 检查 `Backend/config.yaml` 配置
3. 手动运行各个检查步骤
4. 查阅项目文档

---

## 更新日志

### v1.0.0 (2025-11-19)
- ✨ 首次发布
- ✅ 完整的环境检查
- ✅ 自动数据库初始化
- ✅ 智能依赖安装
- ✅ Ollama 服务检测
- ✅ CUDA/GPU 检测
- ✅ 端口占用检查
