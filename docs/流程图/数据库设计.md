# 数据库设计

### 1. `knowledge_bases` (知识库表)

| 字段名            | 类型       | 说明                                  | 约束                                 |
| ----------------- | ---------- | ------------------------------------- | ------------------------------------ |
| `id`              | INT/BIGINT | 主键ID                                | PK（主键）                           |
| `name`            | VARCHAR    | 知识库名称                            | UNI（唯一）                          |
| `embedding_model` | VARCHAR    | 嵌入模型名称（如 `all-MiniLM-L6-v2`） |                                      |
| `description`     | TEXT       | 知识库描述                            |                                      |
| `file_count`      | INT        | 关联文件数量                          | DEFAULT 0                            |
| `chunk_count`     | INT        | 文本块总数                            | DEFAULT 0                            |
| `status`          | VARCHAR    | 状态                                  | ENUM（`ready`/`processing`/`error`） |

### 2. `files` (文件表)

| 字段名         | 类型       | 说明                                     | 约束                                                         |
| -------------- | ---------- | ---------------------------------------- | ------------------------------------------------------------ |
| `id`           | INT/BIGINT | 主键ID                                   | PK                                                           |
| `kb_id`        | INT/BIGINT | 关联知识库ID                             | FK → `knowledge_bases.id`                                    |
| `filename`     | VARCHAR    | 原始文件名（如 `report.pdf`）            |                                                              |
| `file_type`    | VARCHAR    | 文件类型                                 | ENUM（`txt`/`pdf`/`docx`/`html`/`md`）                       |
| `file_size`    | INT        | 文件大小（字节）                         |                                                              |
| `file_hash`    | VARCHAR    | MD5哈希（用于去重）                      |                                                              |
| `storage_path` | VARCHAR    | 文件存储路径（如 `/data/files/xxx.pdf`） |                                                              |
| `chunk_count`  | INT        | 生成的文本块数量                         | DEFAULT 0                                                    |
| `status`       | VARCHAR    | 状态                                     | ENUM（`uploaded`/`parsing`/`parsed`/`embedding`/`completed`/`error`） |

### 3. `text_chunks` (文本块表)

| 字段名        | 类型       | 说明                           | 约束                      |
| ------------- | ---------- | ------------------------------ | ------------------------- |
| `id`          | INT/BIGINT | 主键ID                         | PK                        |
| `kb_id`       | INT/BIGINT | 关联知识库ID                   | FK → `knowledge_bases.id` |
| `file_id`     | INT/BIGINT | 关联文件ID                     | FK → `files.id`           |
| `chunk_index` | INT        | 文本块在文件中的索引（顺序）   |                           |
| `content`     | TEXT       | 文本块内容                     |                           |
| `vector_id`   | VARCHAR    | ChromaDB中的向量ID（用于检索） |                           |

### 4. `assistants` (智能助手表)

| 字段名               | 类型       | 说明                                   | 约束                             |
| -------------------- | ---------- | -------------------------------------- | -------------------------------- |
| `id`                 | INT/BIGINT | 主键ID                                 | PK                               |
| `name`               | VARCHAR    | 助手名称（如 `技术支持助手`）          |                                  |
| `kb_ids`             | VARCHAR    | 关联知识库ID列表（逗号分隔，如 `1,3`） |                                  |
| `embedding_model`    | VARCHAR    | 嵌入模型名称                           |                                  |
| `llm_model`          | VARCHAR    | LLM模型名称（如 `gpt-3.5-turbo`）      |                                  |
| `llm_provider`       | VARCHAR    | LLM提供方                              | ENUM（`local`/`openai`/`azure`） |
| `system_prompt`      | TEXT       | 系统提示词（指导助手行为）             |                                  |
| `color_theme`        | VARCHAR    | 卡片配色（前端展示用）                 |                                  |
| `conversation_count` | INT        | 对话次数统计                           | DEFAULT 0                        |
| `total_messages`     | INT        | 总消息数                               | DEFAULT 0                        |

### 5. `conversations` (对话表)

| 字段名          | 类型       | 说明                                | 约束                 |
| --------------- | ---------- | ----------------------------------- | -------------------- |
| `id`            | INT/BIGINT | 主键ID                              | PK                   |
| `assistant_id`  | INT/BIGINT | 关联智能助手ID                      | FK → `assistants.id` |
| `title`         | VARCHAR    | 对话标题（如 `关于产品功能的咨询`） |                      |
| `message_count` | INT        | 消息数量                            | DEFAULT 0            |

### 6. `messages` (消息表)

| 字段名            | 类型       | 说明                                                | 约束                       |
| ----------------- | ---------- | --------------------------------------------------- | -------------------------- |
| `id`              | INT/BIGINT | 主键ID                                              | PK                         |
| `conversation_id` | INT/BIGINT | 关联对话ID                                          | FK → `conversations.id`    |
| `role`            | VARCHAR    | 角色                                                | ENUM（`user`/`assistant`） |
| `content`         | TEXT       | 消息内容                                            |                            |
| `sources`         | JSON       | RAG来源文档（如 `[{"file_id": 1, "chunk_id": 5}]`） |                            |

### 关系说明

- **知识库与文件**：1对多（一个知识库包含多个文件）
- **文件与文本块**：1对多（一个文件被分割为多个文本块）
- **智能助手与知识库**：多对多（通过 `kb_ids` 字段关联多个知识库ID）
- **智能助手与对话**：1对多（一个助手可以有多个对话）
- **对话与消息**：1对多（一个对话包含多条消息）

