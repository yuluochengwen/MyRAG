# MyRAG 全能启动脚本计划

## 目标
创建一个智能启动脚本，能够自动检测、诊断和修复环境问题，让用户无需手动配置即可运行项目。

---

## 检查项目清单

### 第一阶段：环境检查 (Environment Check)

#### 1. ✅ Conda/Anaconda 安装检查
- **检查项**：
  - 检测 Anaconda/Miniconda 是否安装
  - 检测 conda 命令是否可用
  - 获取 conda 安装路径
- **失败处理**：
  - 显示下载链接和安装指南
  - 提示用户安装后重新运行脚本
  - 可选：询问是否使用系统 Python（不推荐）

#### 2. ✅ MyRAG 虚拟环境检查
- **检查项**：
  - 检测 MyRAG 环境是否存在 (`conda env list`)
  - 检测 Python 版本是否为 3.11
  - 检测环境是否可以正常激活
- **失败处理**：
  - 提示创建命令：`conda create -n MyRAG python=3.11`
  - 可选：询问是否自动创建（需要用户确认）
  - 显示创建进度

#### 3. ✅ Python 依赖包检查
- **检查项**：
  - 检查 requirements.txt 是否存在
  - 检测核心依赖是否安装：
    - fastapi, uvicorn（Web框架）
    - torch, transformers（AI模型）
    - sentence-transformers（嵌入模型）
    - chromadb（向量数据库）
    - pymysql, dbutils（数据库）
    - langchain（文本处理）
  - 检测依赖版本是否兼容
- **失败处理**：
  - 自动执行 `pip install -r requirements.txt`
  - 显示安装进度
  - 如果安装失败，提供错误诊断和建议

---

### 第二阶段：配置文件检查 (Configuration Check)

#### 4. ✅ 配置文件存在性检查
- **检查项**：
  - Backend/config.yaml 是否存在
  - .env 文件是否存在（如果需要）
- **失败处理**：
  - 如果 config.yaml 不存在，从模板创建
  - 提示用户填写必要配置

#### 5. ✅ 配置文件有效性检查
- **检查项**：
  - YAML 格式是否正确
  - 必填字段是否存在：
    - database.host, port, user, password, database
    - embedding.provider, model
    - vector_db.persist_dir
  - 路径配置是否有效
- **失败处理**：
  - 显示具体错误位置和原因
  - 提供修复建议
  - 可选：交互式配置向导

---

### 第三阶段：数据库检查 (Database Check)

#### 6. ✅ MySQL 服务检查
- **检查项**：
  - MySQL/MariaDB 服务是否运行
  - 端口是否可访问（默认3306）
  - 网络连接是否正常
- **失败处理**：
  - 提示启动 MySQL 服务
  - Windows: `net start mysql` 或 `net start mysql80`
  - 提供服务名称检测和建议

#### 7. ✅ 数据库连接检查
- **检查项**：
  - 使用 config.yaml 中的配置测试连接
  - 验证用户名密码是否正确
  - 验证用户权限（是否有 CREATE DATABASE 权限）
- **失败处理**：
  - 显示具体错误信息（连接被拒绝、密码错误等）
  - 提供配置修改指南
  - 提示检查防火墙设置

#### 8. ✅ 数据库存在性检查
- **检查项**：
  - 检测 myrag 数据库是否存在
  - 如果存在，检查字符集是否为 utf8mb4
- **失败处理**：
  - 自动创建数据库：
    ```sql
    CREATE DATABASE IF NOT EXISTS myrag 
    DEFAULT CHARACTER SET utf8mb4 
    DEFAULT COLLATE utf8mb4_unicode_ci;
    ```
  - 显示创建结果

#### 9. ✅ 数据表完整性检查
- **检查项**：
  - 检测必需的表是否存在：
    - knowledge_bases（知识库）
    - files（文件）
    - text_chunks（文本块）
    - conversations（对话）
    - messages（消息）
    - intelligent_assistants（智能助手）
  - 检查表结构是否正确（列数、关键列）
- **失败处理**：
  - 自动执行 `scripts/init_db.py`
  - 显示初始化进度
  - 如果部分表缺失，提示是否重新初始化

---

### 第四阶段：存储目录检查 (Storage Check)

#### 10. ✅ 关键目录检查
- **检查项**：
  - KnowledgeBase/ 是否存在且可写
  - VectorDB/ 是否存在且可写
  - logs/ 是否存在且可写
  - Models/ 目录是否存在
- **失败处理**：
  - 自动创建缺失的目录
  - 检查目录权限
  - 警告磁盘空间不足（<1GB）

#### 11. ✅ 向量数据库检查
- **检查项**：
  - VectorDB/chroma.sqlite3 是否存在
  - ChromaDB 是否可以正常初始化
  - 检查现有集合数量
- **失败处理**：
  - 首次运行会自动创建
  - 如果损坏，提示备份和重建

---

### 第五阶段：外部服务检查 (External Services Check)

#### 12. ✅ Ollama 服务检查（可选）
- **检查项**：
  - Ollama 是否运行在 http://localhost:11434
  - 检测可用的模型：
    - deepseek-v3.1:671b-cloud (LLM)
    - nomic-embed-text:latest (Embedding)
  - API 响应是否正常
- **失败处理**：
  - 如果使用 Ollama，提示启动服务
  - 如果模型缺失，提供下载命令：
    - `ollama pull deepseek-v3.1:671b-cloud`
    - `ollama pull nomic-embed-text`
  - 可选：切换到 Transformers 本地模型

#### 13. ✅ 嵌入模型检查
- **检查项**：
  - 如果使用 transformers：
    - 检查 Models/Embedding/ 下是否有模型文件
    - 检查模型是否可以加载
  - 如果使用 Ollama：
    - 检查服务和模型（第12项）
- **失败处理**：
  - 提供模型下载指南
  - 可选：首次运行时自动下载（需要用户确认）

---

### 第六阶段：GPU/CUDA 检查 (Hardware Check)

#### 14. ✅ CUDA 可用性检查
- **检查项**：
  - 检测 NVIDIA GPU 是否存在
  - 检测 CUDA 是否可用 (`torch.cuda.is_available()`)
  - 检测 CUDA 版本是否兼容
  - 检测 GPU 显存大小
- **失败处理**：
  - 如果无 GPU，自动切换到 CPU 模式
  - 警告 CPU 模式性能较低
  - 如果显存不足（<4GB），建议使用量化模型

---

### 第七阶段：端口检查 (Port Check)

#### 15. ✅ 端口占用检查
- **检查项**：
  - 检测 8000 端口是否被占用（FastAPI）
  - 检测 11434 端口是否被占用（Ollama）
  - 检测 3306 端口是否被占用（MySQL）
- **失败处理**：
  - 显示占用端口的进程信息
  - 提供终止进程的命令
  - 可选：询问是否使用其他端口

---

### 第八阶段：健康检查 (Health Check)

#### 16. ✅ 服务启动后验证
- **检查项**：
  - API 服务是否成功启动
  - /health 端点是否响应
  - 数据库连接池是否正常
  - 向量存储是否初始化成功
- **失败处理**：
  - 显示启动日志
  - 分析错误原因
  - 提供修复建议

---

## 脚本功能特性

### 🎯 核心特性

1. **智能诊断**
   - 自动检测所有依赖和配置
   - 提供清晰的错误信息和修复建议
   - 分步显示检查进度

2. **自动修复**
   - 自动创建缺失的目录
   - 自动初始化数据库
   - 自动安装依赖（需要用户确认）

3. **交互式向导**
   - 首次运行时提供配置向导
   - 询问用户选择（Ollama vs 本地模型）
   - 友好的用户提示

4. **详细日志**
   - 保存检查日志到 logs/startup.log
   - 记录每次启动的检查结果
   - 便于问题追踪

5. **离线模式**
   - 缓存检查结果（.startup_cache）
   - 快速启动模式（跳过已验证的项）
   - 强制完整检查选项（--full-check）

### 🛠️ 实现方式

#### 方案A：批处理脚本（推荐用于 Windows）
- **优点**：
  - 无需额外依赖
  - 直接在 Windows 上运行
  - 启动速度快
- **缺点**：
  - 功能受限
  - 错误处理较弱
  - 代码可读性差

#### 方案B：Python 脚本
- **优点**：
  - 功能强大
  - 错误处理完善
  - 可以复用项目代码
  - 跨平台支持
- **缺点**：
  - 需要 Python 环境
  - 启动稍慢

#### 方案C：混合方案（推荐）
- **实现**：
  - setup.bat（批处理）：环境检查 + 调用 Python 脚本
  - setup.py（Python）：高级检查和初始化
- **优点**：
  - 结合两者优势
  - 灵活性高
  - 用户体验好

---

## 脚本命令行参数

```bash
setup.bat [options]

Options:
  --full-check       强制完整检查，忽略缓存
  --skip-deps        跳过依赖检查（假设已安装）
  --skip-db          跳过数据库检查
  --no-auto-fix      不自动修复，仅显示问题
  --silent           静默模式，减少输出
  --dev              开发模式，启用详细日志
  --help             显示帮助信息
```

---

## 用户体验设计

### 成功场景
```
========================================
  MyRAG 智能启动检查
========================================

[1/16] 检查 Conda 环境...           ✓
[2/16] 检查 MyRAG 虚拟环境...       ✓
[3/16] 检查 Python 依赖...          ✓ (cached)
[4/16] 检查配置文件...              ✓
[5/16] 检查配置有效性...            ✓
[6/16] 检查 MySQL 服务...           ✓
[7/16] 检查数据库连接...            ✓
[8/16] 检查数据库存在性...          ✓
[9/16] 检查数据表...                ✓ (6/6 tables)
[10/16] 检查存储目录...             ✓
[11/16] 检查向量数据库...           ✓
[12/16] 检查 Ollama 服务...         ✓ (2 models)
[13/16] 检查嵌入模型...             ✓
[14/16] 检查 CUDA 可用性...         ✓ (RTX 3060, 6GB)
[15/16] 检查端口占用...             ✓
[16/16] 启动服务...                 ✓

========================================
✨ 所有检查通过！服务已启动
========================================

API 服务: http://localhost:8000
API 文档: http://localhost:8000/docs
前端页面: ./Frontend/chat.html

按任意键停止服务...
```

### 失败场景（示例）
```
[6/16] 检查 MySQL 服务...           ❌

错误: MySQL 服务未运行

修复建议:
  1. 启动 MySQL 服务:
     net start mysql80

  2. 检查服务名称:
     sc query type= service state= all | findstr MySQL

  3. 验证 MySQL 是否已安装

是否尝试自动启动服务？ (Y/n): 
```

---

## 优先级排序

### 高优先级（必须实现）
1. ✅ Conda 环境检查
2. ✅ 依赖包检查
3. ✅ 数据库连接检查
4. ✅ 数据表完整性检查
5. ✅ 配置文件检查
6. ✅ 关键目录检查

### 中优先级（建议实现）
7. ✅ MySQL 服务检查
8. ✅ 端口占用检查
9. ✅ CUDA 可用性检查
10. ✅ Ollama 服务检查
11. ✅ 向量数据库检查

### 低优先级（可选实现）
12. ✅ 配置有效性检查
13. ✅ 嵌入模型检查
14. ✅ 服务启动后验证
15. ✅ 磁盘空间检查

---

## 下一步行动

请审核此计划，并告诉我：

1. **是否有需要添加或删除的检查项？**
2. **优先级排序是否合理？**
3. **选择哪种实现方案？**
   - 方案A：纯批处理（快速但功能有限）
   - 方案B：纯Python（功能强但需要Python环境）
   - 方案C：混合方案（推荐，灵活性高）
4. **是否需要交互式配置向导？**
5. **是否需要自动修复功能？**

确认后我将开始实现全能启动脚本。
