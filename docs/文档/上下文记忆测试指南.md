# ğŸ§ª ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½æµ‹è¯•æŒ‡å—

## âœ… å·²å®Œæˆçš„ä¿®å¤

### é—®é¢˜è¯Šæ–­
**åŸé—®é¢˜:** å‰ç«¯æ²¡æœ‰ä¼ é€’ `max_history_turns` å‚æ•°ï¼Œå¯¼è‡´åç«¯å§‹ç»ˆæ”¶åˆ°é»˜è®¤å€¼ï¼Œå†å²æ¶ˆæ¯æ— æ³•æ­£ç¡®ä¼ é€’ç»™LLMã€‚

### ä¿®å¤å†…å®¹

#### 1. å‰ç«¯è¯·æ±‚ä¿®å¤ (`Frontend/js/chat.js`)

**éæµå¼è¯·æ±‚:**
```javascript
const maxHistoryTurns = parseInt(document.getElementById('maxHistoryTurns')?.value || '10');
const response = await fetch(`${API_BASE_URL}/api/conversations/${currentConversation.id}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        query: query,
        temperature: 0.7,
        max_tokens: 2048,
        max_history_turns: maxHistoryTurns  // âœ… æ–°å¢
    })
});
```

**æµå¼è¯·æ±‚:**
```javascript
const maxHistoryTurns = parseInt(document.getElementById('maxHistoryTurns')?.value || '10');
const response = await fetch(`${API_BASE_URL}/api/conversations/${currentConversation.id}/chat/stream`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        query: query,
        temperature: 0.7,
        max_tokens: 2048,
        max_history_turns: maxHistoryTurns  // âœ… æ–°å¢
    })
});
```

---

#### 2. å‰ç«¯UIå¢å¼º (`Frontend/chat.html`)

åœ¨å·¥å…·æ æ·»åŠ **ä¸Šä¸‹æ–‡è®°å¿†æ§åˆ¶åŒº**ï¼š

```html
<!-- ä¸Šä¸‹æ–‡è®°å¿†æ§åˆ¶ -->
<div class="flex items-center space-x-2">
  <label class="text-xs text-gray-600 flex items-center space-x-1">
    <i class="fa fa-brain"></i>
    <span>è®°å¿†è½®æ•°:</span>
  </label>
  <input type="number" id="maxHistoryTurns" value="10" min="0" max="50" 
         class="w-16 px-2 py-1 text-xs border border-gray-300 rounded">
</div>
```

**UIä½ç½®:** å·¥å…·æ å³ä¾§ï¼Œæµå¼å“åº”å¼€å…³å·¦è¾¹

---

#### 3. è®°å¿†çŠ¶æ€æ™ºèƒ½æç¤º (`Frontend/js/chat.js`)

æ·»åŠ äº†ä¸‰ä¸ªæ–°å‡½æ•°ï¼š

1. **getCurrentMemoryTurns()** - è·å–å½“å‰è®°å¿†è½®æ•°è®¾ç½®
2. **updateMemoryStatus()** - æ›´æ–°è¾“å…¥æ¡†è¾¹æ¡†é¢œè‰²å’Œæç¤º
   - `0è½®` â†’ çº¢è‰²è¾¹æ¡† â†’ "ä¸Šä¸‹æ–‡è®°å¿†å·²ç¦ç”¨"
   - `1-5è½®` â†’ é»„è‰²è¾¹æ¡† â†’ "çŸ­æœŸè®°å¿†"
   - `6+è½®` â†’ ç»¿è‰²è¾¹æ¡† â†’ "æ ‡å‡†è®°å¿†"
3. **äº‹ä»¶ç›‘å¬** - è¾“å…¥æ¡†å˜åŒ–æ—¶å®æ—¶æ›´æ–°æç¤º

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤1: é‡å¯åç«¯
```powershell
cd C:\Users\Man\Desktop\MyRAG
.\start.bat
```

### æ­¥éª¤2: æ‰“å¼€èŠå¤©é¡µé¢
è®¿é—®: `http://localhost:8000/chat.html?assistant_id=<ä½ çš„åŠ©æ‰‹ID>`

### æ­¥éª¤3: åŸºç¡€è®°å¿†æµ‹è¯•

**æµ‹è¯•A: åå­—è®°å¿†ï¼ˆ10è½®è®°å¿†ï¼Œé»˜è®¤è®¾ç½®ï¼‰**

1. ç¡®è®¤å·¥å…·æ æ˜¾ç¤º "è®°å¿†è½®æ•°: 10"ï¼ˆç»¿è‰²è¾¹æ¡†ï¼‰
2. å‘é€: "æˆ‘å«å¼ ä¸‰"
3. AIå›å¤: "ä½ å¥½ï¼Œå¼ ä¸‰ï¼..."
4. å‘é€: "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"
5. **é¢„æœŸç»“æœ:** AIåº”è¯¥å›ç­” "ä½ å«å¼ ä¸‰" âœ…

---

**æµ‹è¯•B: å¤šè½®æ¨ç†ï¼ˆéªŒè¯ä¸Šä¸‹æ–‡è¿ç»­æ€§ï¼‰**

1. å‘é€: "1+1ç­‰äºå‡ ï¼Ÿ"
2. AIå›å¤: "2"
3. å‘é€: "é‚£è¿™ä¸ªæ•°å­—åŠ 3å‘¢ï¼Ÿ"
4. **é¢„æœŸç»“æœ:** AIåº”è¯¥å›ç­” "5"ï¼ˆç†è§£"è¿™ä¸ªæ•°å­—"æŒ‡çš„æ˜¯2ï¼‰ âœ…

---

**æµ‹è¯•C: ä»£è¯æŒ‡ä»£ï¼ˆéªŒè¯è¯­ä¹‰ç†è§£ï¼‰**

1. å‘é€: "åä¸ºæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"
2. AIå›å¤: [ä»‹ç»åä¸º]
3. å‘é€: "å®ƒçš„åˆ›å§‹äººæ˜¯è°ï¼Ÿ"
4. **é¢„æœŸç»“æœ:** AIåº”è¯¥ç†è§£"å®ƒ"æŒ‡åä¸ºï¼Œå›ç­”"ä»»æ­£é" âœ…

---

### æ­¥éª¤4: ç¦ç”¨è®°å¿†æµ‹è¯•

**æµ‹è¯•D: ç¦ç”¨ä¸Šä¸‹æ–‡è®°å¿†ï¼ˆ0è½®è®°å¿†ï¼‰**

1. å°†å·¥å…·æ çš„"è®°å¿†è½®æ•°"è®¾ä¸º `0`ï¼ˆè¾¹æ¡†å˜çº¢ï¼‰
2. å‘é€: "æˆ‘å«æå››"
3. AIå›å¤: "ä½ å¥½ï¼Œæå››ï¼"
4. å‘é€: "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"
5. **é¢„æœŸç»“æœ:** AIåº”è¯¥å›ç­” "æˆ‘ä¸çŸ¥é“" æˆ– "æ‚¨è¿˜æ²¡å‘Šè¯‰æˆ‘" âŒï¼ˆä¸è®°å¿†ï¼‰

---

### æ­¥éª¤5: çŸ­æœŸè®°å¿†æµ‹è¯•

**æµ‹è¯•E: çŸ­æœŸè®°å¿†ï¼ˆ3è½®è®°å¿†ï¼‰**

1. æ¸…é™¤å¯¹è¯ï¼ˆç‚¹å‡»"æ¸…é™¤å¯¹è¯"æŒ‰é’®ï¼‰
2. å°†"è®°å¿†è½®æ•°"è®¾ä¸º `3`ï¼ˆè¾¹æ¡†å˜é»„ï¼‰
3. è¿›è¡Œ7è½®å¯¹è¯ï¼š
   ```
   ç¬¬1è½®: ä½ : "æˆ‘å–œæ¬¢è“è‰²"  AI: "..."
   ç¬¬2è½®: ä½ : "æˆ‘å–œæ¬¢è‹¹æœ"  AI: "..."
   ç¬¬3è½®: ä½ : "æˆ‘å–œæ¬¢è·‘æ­¥"  AI: "..."
   ç¬¬4è½®: ä½ : "æˆ‘å–œæ¬¢éŸ³ä¹"  AI: "..."
   ç¬¬5è½®: ä½ : "æˆ‘å–œæ¬¢ä»€ä¹ˆé¢œè‰²ï¼Ÿ"
   ```
4. **é¢„æœŸç»“æœ:** AIåº”è¯¥å›ç­” "è“è‰²" âœ…ï¼ˆç¬¬1è½®ä»åœ¨è®°å¿†çª—å£å†…ï¼‰
5. ç»§ç»­ç¬¬6è½®: "æˆ‘ç¬¬ä¸€ä¸ªè¯´å–œæ¬¢ä»€ä¹ˆï¼Ÿ"
6. **é¢„æœŸç»“æœ:** AIå¯èƒ½å¿˜è®°"è“è‰²"ï¼ˆè¶…å‡º3è½®çª—å£ï¼‰ âŒ

---

### æ­¥éª¤6: æŸ¥çœ‹åç«¯æ—¥å¿—éªŒè¯

æ‰“å¼€åç«¯æ—¥å¿—ï¼ŒæŸ¥çœ‹ç±»ä¼¼ä¿¡æ¯ï¼š
```
è°ƒç”¨Transformersæ¨¡å‹ï¼ˆæµå¼ï¼‰: DeepSeek-R1-Distill-Qwen-1.5B, å†å²æ¶ˆæ¯: 2æ¡
è°ƒç”¨Transformersæ¨¡å‹ï¼ˆæµå¼ï¼‰: DeepSeek-R1-Distill-Qwen-1.5B, å†å²æ¶ˆæ¯: 4æ¡
è°ƒç”¨Transformersæ¨¡å‹ï¼ˆæµå¼ï¼‰: DeepSeek-R1-Distill-Qwen-1.5B, å†å²æ¶ˆæ¯: 6æ¡
```

**éªŒè¯ç‚¹:**
- âœ… æ¯æ¬¡å¯¹è¯åï¼Œå†å²æ¶ˆæ¯æ•°é‡å¢åŠ 2æ¡ï¼ˆuser + assistantï¼‰
- âœ… è¾¾åˆ°max_history_turns*2åï¼Œæ•°é‡ä¸å†å¢åŠ ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
- âœ… è®¾ä¸º0æ—¶ï¼Œæ˜¾ç¤º"å†å²æ¶ˆæ¯: 0æ¡"

---

## ğŸ¨ UIåŠŸèƒ½æ¼”ç¤º

### è®°å¿†çŠ¶æ€é¢œè‰²æŒ‡ç¤º

| è®¾ç½®å€¼ | è¾¹æ¡†é¢œè‰² | æç¤ºæ–‡æœ¬ | é€‚ç”¨åœºæ™¯ |
|--------|----------|----------|----------|
| 0 | ğŸ”´ çº¢è‰² | "ä¸Šä¸‹æ–‡è®°å¿†å·²ç¦ç”¨" | å•æ¬¡é—®ç­”ï¼Œä¸éœ€è¦è®°å¿† |
| 1-5 | ğŸŸ¡ é»„è‰² | "çŸ­æœŸè®°å¿† - è®°ä½æœ€è¿‘Xè½®" | ç®€çŸ­å¯¹è¯ |
| 6-50 | ğŸŸ¢ ç»¿è‰² | "æ ‡å‡†è®°å¿† - è®°ä½æœ€è¿‘Xè½®" | æ­£å¸¸å¯¹è¯ï¼ˆæ¨è10è½®ï¼‰ |

### å·¥å…·æ å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [æ¸…é™¤å¯¹è¯] [å¤åˆ¶å›å¤] â”‚ ğŸ’¬ 12æ¡æ¶ˆæ¯   ğŸ§  è®°å¿†è½®æ•°:[10] âš¡æµå¼å“åº”[â—] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ—¥å¿—æ˜¾ç¤º"å†å²æ¶ˆæ¯: 0æ¡"

**å¯èƒ½åŸå› :**
1. å‰ç«¯æœªæ­£ç¡®ä¼ é€’ `max_history_turns` å‚æ•°
2. å¯¹è¯æ˜¯æ–°å»ºçš„ï¼Œè¿˜æ²¡æœ‰å†å²æ¶ˆæ¯

**è§£å†³æ–¹æ¡ˆ:**
- æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network â†’ è¯·æ±‚Bodyæ˜¯å¦åŒ…å« `max_history_turns`
- ç¡®ä¿è‡³å°‘è¿›è¡Œè¿‡1è½®å¯¹è¯åå†æµ‹è¯•

---

### é—®é¢˜2: AIä»ç„¶ä¸è®°å¾—ä¹‹å‰çš„å¯¹è¯

**å¯èƒ½åŸå› :**
1. `max_history_turns` è®¾ä¸º0
2. ä½¿ç”¨äº†ä¸åŒçš„å¯¹è¯ID
3. æ•°æ®åº“ä¸­æ²¡æœ‰å†å²æ¶ˆæ¯

**è§£å†³æ–¹æ¡ˆ:**
- ç¡®è®¤"è®°å¿†è½®æ•°"è¾“å…¥æ¡†æ˜¾ç¤ºçš„å€¼ > 0
- ç¡®ä¿åœ¨åŒä¸€ä¸ªå¯¹è¯ä¸­æµ‹è¯•
- æ£€æŸ¥æ•°æ®åº“ `messages` è¡¨æ˜¯å¦æœ‰è®°å½•

---

### é—®é¢˜3: è®°å¿†çª—å£ä¸ç¬¦åˆé¢„æœŸ

**ç¤ºä¾‹:** è®¾ç½®10è½®ï¼Œä½†åªè®°ä½5è½®

**å¯èƒ½åŸå› :**
- æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£é™åˆ¶ï¼ˆDeepSeek-R1-Distill-Qwen-1.5B: 8K tokensï¼‰
- æ¯æ¡æ¶ˆæ¯è¿‡é•¿ï¼ŒTokenæå‰è€—å°½

**è§£å†³æ–¹æ¡ˆ:**
- å‡å°‘ `max_history_turns` åˆ°5æˆ–æ›´å°‘
- ç¼©çŸ­æ¯æ¡æ¶ˆæ¯çš„é•¿åº¦

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### Tokenæ¶ˆè€—å¯¹æ¯”

| è®°å¿†è½®æ•° | å†å²æ¶ˆæ¯æ•° | ä¼°ç®—Token | å“åº”é€Ÿåº¦ |
|----------|------------|-----------|----------|
| 0 | 0æ¡ | ~200 | å¿« âš¡âš¡âš¡ |
| 5 | 10æ¡ | ~500 | è¾ƒå¿« âš¡âš¡ |
| 10 | 20æ¡ | ~800 | æ­£å¸¸ âš¡ |
| 20 | 40æ¡ | ~1500 | è¾ƒæ…¢ ğŸ¢ |

**å»ºè®®é…ç½®:**
- **æ—¥å¸¸ä½¿ç”¨:** 10è½®ï¼ˆé»˜è®¤ï¼‰
- **ç®€çŸ­é—®ç­”:** 5è½®
- **é•¿ç¯‡å¯¹è¯:** 15è½®
- **æ€§èƒ½ä¼˜å…ˆ:** 0è½®

---

## âœ¨ æ–°å¢åŠŸèƒ½æ€»ç»“

### 1. å‰ç«¯æ§åˆ¶é¢æ¿
- âœ… è®°å¿†è½®æ•°è¾“å…¥æ¡†ï¼ˆ0-50å¯è°ƒï¼‰
- âœ… æ™ºèƒ½è¾¹æ¡†é¢œè‰²æç¤ºï¼ˆçº¢/é»„/ç»¿ï¼‰
- âœ… æ‚¬åœæ˜¾ç¤ºè¯¦ç»†è¯´æ˜

### 2. è¯·æ±‚å‚æ•°ä¼ é€’
- âœ… éæµå¼è¯·æ±‚ä¼ é€’ `max_history_turns`
- âœ… æµå¼è¯·æ±‚ä¼ é€’ `max_history_turns`

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- âœ… å®æ—¶æ›´æ–°è®°å¿†çŠ¶æ€æç¤º
- âœ… è¾“å…¥æ¡†å˜åŒ–ç«‹å³åé¦ˆ
- âœ… é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–çŠ¶æ€

---

## ğŸ‰ å®Œæˆæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹ç°è±¡ï¼Œè¯´æ˜åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼š

1. âœ… å·¥å…·æ æ˜¾ç¤º"è®°å¿†è½®æ•°"è¾“å…¥æ¡†
2. âœ… ä¿®æ”¹æ•°å€¼æ—¶è¾¹æ¡†é¢œè‰²å˜åŒ–ï¼ˆçº¢â†’é»„â†’ç»¿ï¼‰
3. âœ… åç«¯æ—¥å¿—æ˜¾ç¤º "å†å²æ¶ˆæ¯: Xæ¡"ï¼ˆX > 0ï¼‰
4. âœ… AIèƒ½æ­£ç¡®å›ç­”"æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"
5. âœ… AIèƒ½ç†è§£ä»£è¯æŒ‡ä»£ï¼ˆ"å®ƒ"ã€"è¿™ä¸ª"ç­‰ï¼‰

---

**ç°åœ¨å¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼** ğŸš€

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
2. æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„"å†å²æ¶ˆæ¯"æ•°é‡
3. ç¡®è®¤æ•°æ®åº“ä¸­æœ‰å†å²è®°å½•
