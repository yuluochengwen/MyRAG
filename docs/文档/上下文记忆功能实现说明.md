# ğŸ§  ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½å®ç°è¯´æ˜

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. æ·»åŠ å‚æ•°é…ç½®

**æ–‡ä»¶:** `Backend/app/api/conversation.py`

```python
class AssistantChatRequest(BaseModel):
    """æ™ºèƒ½åŠ©æ‰‹èŠå¤©è¯·æ±‚"""
    query: str
    temperature: Optional[float] = 0.7
    max_tokens: Optional[int] = 2048
    max_history_turns: Optional[int] = 10  # æœ€å¤šè¯»å–10è½®å†å²å¯¹è¯ï¼ˆ20æ¡æ¶ˆæ¯ï¼‰
```

**è¯´æ˜:** 
- `max_history_turns` é»˜è®¤å€¼ä¸º 10ï¼Œå³æœ€å¤šè¯»å–æœ€è¿‘ 10 è½®å¯¹è¯ï¼ˆ20 æ¡æ¶ˆæ¯ï¼‰
- å¯ä»¥é€šè¿‡å‰ç«¯ä¼ å‚è°ƒæ•´ï¼Œè®¾ä¸º 0 åˆ™ç¦ç”¨ä¸Šä¸‹æ–‡è®°å¿†

---

### 2. éæµå¼èŠå¤©ç«¯ç‚¹ï¼ˆè¯»å–å†å²æ¶ˆæ¯ï¼‰

**æ–‡ä»¶:** `Backend/app/api/conversation.py` - `chat_with_assistant()` å‡½æ•°

**å…³é”®ä¿®æ”¹:**

```python
# 4. è¯»å–å†å²æ¶ˆæ¯ï¼ˆç”¨äºä¸Šä¸‹æ–‡è®°å¿†ï¼‰
max_messages = request.max_history_turns * 2  # æ¯è½®å¯¹è¯=2æ¡æ¶ˆæ¯
cursor.execute(
    """SELECT role, content 
       FROM messages 
       WHERE conversation_id = %s 
       ORDER BY created_at DESC 
       LIMIT %s""",
    (conversation_id, max_messages)
)
history_rows = cursor.fetchall()
history_messages = list(reversed(history_rows))  # åè½¬ä¸ºæ—¶é—´æ­£åº

# 6. è°ƒç”¨èŠå¤©æœåŠ¡ï¼ˆä¼ é€’å†å²æ¶ˆæ¯ï¼‰
result = await chat_service.chat_with_assistant(
    kb_ids=kb_ids,
    query=request.query,
    history_messages=history_messages,  # æ–°å¢å‚æ•°
    system_prompt=assistant['system_prompt'],
    # ...
)
```

**æµç¨‹:**
1. ä»æ•°æ®åº“è¯»å–æœ€è¿‘ N æ¡å†å²æ¶ˆæ¯ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
2. åè½¬ä¸ºæ—¶é—´æ­£åºï¼ˆæ—§â†’æ–°ï¼‰
3. ä¼ é€’ç»™ `chat_service.chat_with_assistant()`

---

### 3. æµå¼èŠå¤©ç«¯ç‚¹ï¼ˆè¯»å–å†å²æ¶ˆæ¯ï¼‰

**æ–‡ä»¶:** `Backend/app/api/conversation.py` - `chat_with_assistant_stream()` å‡½æ•°

**å…³é”®ä¿®æ”¹:**

```python
# è¯»å–å†å²æ¶ˆæ¯ï¼ˆç”¨äºä¸Šä¸‹æ–‡è®°å¿†ï¼‰
max_messages = request.max_history_turns * 2
cursor.execute(
    """SELECT role, content 
       FROM messages 
       WHERE conversation_id = %s 
       ORDER BY created_at DESC 
       LIMIT %s""",
    (conversation_id, max_messages)
)
history_rows = cursor.fetchall()
history_messages = list(reversed(history_rows))  # åè½¬ä¸ºæ—¶é—´æ­£åº

# è°ƒç”¨æµå¼èŠå¤©æœåŠ¡ï¼ˆä¼ é€’å†å²æ¶ˆæ¯ï¼‰
async for chunk in chat_service.chat_stream(
    kb_ids=kb_ids,
    query=request.query,
    history_messages=history_messages,
    # ...
):
```

**è¯´æ˜:** æµå¼ç‰ˆæœ¬ä¸éæµå¼ç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„å†å²æ¶ˆæ¯è¯»å–é€»è¾‘

---

### 4. ChatService æ”¯æŒå†å²æ¶ˆæ¯

**æ–‡ä»¶:** `Backend/app/services/chat_service.py`

#### 4.1 ä¿®æ”¹ `chat_with_assistant()` æ–¹æ³•

```python
async def chat_with_assistant(
    self,
    kb_ids: Optional[List[int]],
    query: str,
    history_messages: Optional[List[Dict[str, str]]] = None,  # æ–°å¢å‚æ•°
    system_prompt: Optional[str] = None,
    # ...
) -> Dict[str, Any]:
    """
    æ™ºèƒ½åŠ©æ‰‹å¯¹è¯ï¼ˆæ”¯æŒå¤šçŸ¥è¯†åº“ + ä¸Šä¸‹æ–‡è®°å¿†ï¼‰
    
    Args:
        history_messages: å†å²æ¶ˆæ¯åˆ—è¡¨ [{"role": "user", "content": "..."}, ...]
    """
```

#### 4.2 ä¿®æ”¹ `chat_stream()` æ–¹æ³•

```python
async def chat_stream(
    self,
    kb_ids: Optional[List[int]],
    query: str,
    history_messages: Optional[List[Dict[str, str]]] = None,  # æ–°å¢å‚æ•°
    # ...
):
    """æ™ºèƒ½åŠ©æ‰‹æµå¼å¯¹è¯ï¼ˆæ”¯æŒä¸Šä¸‹æ–‡è®°å¿†ï¼‰"""
```

#### 4.3 ä¿®æ”¹ `_generate_answer()` æ„å»º messages é€»è¾‘

```python
async def _generate_answer(
    self,
    query: str,
    context: Optional[str],
    history_messages: Optional[List[Dict[str, str]]],  # æ–°å¢å‚æ•°
    # ...
) -> str:
    """è°ƒç”¨LLMç”Ÿæˆå›ç­”ï¼ˆæ”¯æŒä¸Šä¸‹æ–‡è®°å¿†ï¼‰"""
    
    # æ„å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆåŒ…å«å†å²æ¶ˆæ¯ï¼‰
    messages = []
    
    # 1. System prompt
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})
    
    # 2. å†å²æ¶ˆæ¯
    if history_messages:
        for msg in history_messages:
            messages.append({"role": msg['role'], "content": msg['content']})
    
    # 3. å½“å‰ç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«RAGä¸Šä¸‹æ–‡ï¼‰
    messages.append({"role": "user", "content": user_message})
    
    logger.info(f"è°ƒç”¨Transformersæ¨¡å‹: {model_name}, å†å²æ¶ˆæ¯: {len(history_messages) if history_messages else 0}æ¡")
```

#### 4.4 ä¿®æ”¹ `_generate_answer_stream()` æ„å»º messages é€»è¾‘

```python
async def _generate_answer_stream(
    self,
    query: str,
    context: Optional[str],
    history_messages: Optional[List[Dict[str, str]]],  # æ–°å¢å‚æ•°
    # ...
):
    """æµå¼è°ƒç”¨LLMç”Ÿæˆå›ç­”ï¼ˆæ”¯æŒä¸Šä¸‹æ–‡è®°å¿†ï¼‰"""
    
    # æ„å»ºå®Œæ•´çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆåŒ…å«å†å²æ¶ˆæ¯ï¼‰
    messages = []
    
    # 1. System prompt
    if system_prompt:
        messages.append({"role": "system", "content": system_prompt})
    
    # 2. å†å²æ¶ˆæ¯
    if history_messages:
        for msg in history_messages:
            messages.append({"role": msg['role'], "content": msg['content']})
    
    # 3. å½“å‰ç”¨æˆ·æ¶ˆæ¯
    messages.append({"role": "user", "content": user_message})
    
    logger.info(f"è°ƒç”¨Transformersæ¨¡å‹ï¼ˆæµå¼ï¼‰: {model_name}, å†å²æ¶ˆæ¯: {len(history_messages) if history_messages else 0}æ¡")
```

---

## ğŸ“Š å®Œæ•´å¯¹è¯æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šå¤šè½®å¯¹è¯

**ç¬¬1è½®å¯¹è¯:**
```
ç”¨æˆ·: æˆ‘å«å¼ ä¸‰
AI: ä½ å¥½ï¼Œå¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚

æ•°æ®åº“ä¿å­˜:
- messages[1]: {"role": "user", "content": "æˆ‘å«å¼ ä¸‰"}
- messages[2]: {"role": "assistant", "content": "ä½ å¥½ï¼Œå¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"}
```

**ç¬¬2è½®å¯¹è¯:**
```
ç”¨æˆ·: æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ

åç«¯å¤„ç†:
1. è¯»å–å†å²æ¶ˆæ¯: 
   history_messages = [
       {"role": "user", "content": "æˆ‘å«å¼ ä¸‰"},
       {"role": "assistant", "content": "ä½ å¥½ï¼Œå¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"}
   ]

2. æ„å»º LLM messages:
   [
       {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹"},
       {"role": "user", "content": "æˆ‘å«å¼ ä¸‰"},
       {"role": "assistant", "content": "ä½ å¥½ï¼Œå¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚"},
       {"role": "user", "content": "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"}
   ]

AI: ä½ å«å¼ ä¸‰ã€‚
```

âœ… **æˆåŠŸï¼AI è®°ä½äº†ç”¨æˆ·çš„åå­—**

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯•1: åŸºç¡€è®°å¿†æµ‹è¯•

**å¯¹è¯åºåˆ—:**
1. ç”¨æˆ·: "æˆ‘å«å¼ ä¸‰"
2. AI: "ä½ å¥½ï¼Œå¼ ä¸‰ï¼"
3. ç”¨æˆ·: "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"
4. **é¢„æœŸç»“æœ:** AI åº”è¯¥å›ç­” "ä½ å«å¼ ä¸‰"

---

### æµ‹è¯•2: å¤šè½®æ¨ç†æµ‹è¯•

**å¯¹è¯åºåˆ—:**
1. ç”¨æˆ·: "1+1ç­‰äºå‡ ï¼Ÿ"
2. AI: "2"
3. ç”¨æˆ·: "é‚£è¿™ä¸ªæ•°å­—åŠ 3å‘¢ï¼Ÿ"
4. **é¢„æœŸç»“æœ:** AI åº”è¯¥å›ç­” "5" ï¼ˆè®°ä½å‰é¢è¯´çš„æ˜¯2ï¼‰

---

### æµ‹è¯•3: ä»£è¯æŒ‡ä»£æµ‹è¯•

**å¯¹è¯åºåˆ—:**
1. ç”¨æˆ·: "åä¸ºæ˜¯ä»€ä¹ˆå…¬å¸ï¼Ÿ"
2. AI: "åä¸ºæ˜¯ä¸­å›½çš„é€šä¿¡è®¾å¤‡åˆ¶é€ å•†..."
3. ç”¨æˆ·: "å®ƒçš„åˆ›å§‹äººæ˜¯è°ï¼Ÿ"
4. **é¢„æœŸç»“æœ:** AI åº”è¯¥ç†è§£ "å®ƒ" æŒ‡çš„æ˜¯åä¸ºï¼Œå›ç­” "ä»»æ­£é"

---

### æµ‹è¯•4: çŸ¥è¯†åº“ + ä¸Šä¸‹æ–‡è®°å¿†æ··åˆæµ‹è¯•

**å¯¹è¯åºåˆ—:**
1. ç”¨æˆ·: "åä¸ºå‘˜å·¥å®ˆåˆ™é‡Œå…³äºä¿å¯†çš„è§„å®šæ˜¯ä»€ä¹ˆï¼Ÿ"ï¼ˆRAGæ£€ç´¢ï¼‰
2. AI: [åŸºäºçŸ¥è¯†åº“å›ç­”]
3. ç”¨æˆ·: "åˆšæ‰é‚£æ¡è§„å®šçš„ç¬¬3ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"ï¼ˆä¸Šä¸‹æ–‡è®°å¿†ï¼‰
4. **é¢„æœŸç»“æœ:** AI åº”è¯¥è®°ä½åˆšæ‰å›ç­”çš„å†…å®¹ï¼Œå‡†ç¡®è¯´å‡ºç¬¬3ç‚¹

---

### æµ‹è¯•5: é•¿å¯¹è¯æ»‘åŠ¨çª—å£æµ‹è¯•

**å¯¹è¯åºåˆ—:**
- è¿›è¡Œ 15 è½®å¯¹è¯ï¼ˆè¶…è¿‡é»˜è®¤çš„ 10 è½®é™åˆ¶ï¼‰
- åœ¨ç¬¬ 16 è½®è¯¢é—®ç¬¬ 1 è½®çš„å†…å®¹
- **é¢„æœŸç»“æœ:** AI åº”è¯¥å¿˜è®°ç¬¬ 1-6 è½®çš„å†…å®¹ï¼ˆè¢«æ»‘åŠ¨çª—å£æˆªæ–­ï¼‰

---

## âš™ï¸ é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `max_history_turns` | int | 10 | æœ€å¤šè¯»å–çš„å†å²å¯¹è¯è½®æ•° |
| å®é™…è¯»å–æ¶ˆæ¯æ•° | - | 20 | `max_history_turns Ã— 2`ï¼ˆæ¯è½®=user+assistantï¼‰ |
| Token æ¶ˆè€—ä¼°ç®— | - | ~800 tokens | 10è½®å¯¹è¯çº¦ 800 tokens |

**å»ºè®®é…ç½®:**
- **DeepSeek-R1-Distill-Qwen-1.5B** (8K ä¸Šä¸‹æ–‡): `max_history_turns = 10` âœ…
- **çŸ­å¯¹è¯åœºæ™¯**: `max_history_turns = 5`
- **é•¿å¯¹è¯åœºæ™¯**: `max_history_turns = 15`
- **ç¦ç”¨ä¸Šä¸‹æ–‡è®°å¿†**: `max_history_turns = 0`

---

## ğŸ“ˆ æ€§èƒ½å½±å“è¯„ä¼°

| é¡¹ç›® | æ·»åŠ ä¸Šä¸‹æ–‡å‰ | æ·»åŠ ä¸Šä¸‹æ–‡å (10è½®) |
|------|-------------|---------------------|
| Token æ¶ˆè€— | ~200 tokens | ~800 tokens |
| å“åº”é€Ÿåº¦ | åŸºå‡† | +200ms (è¾“å…¥å¤„ç†) |
| å†…å­˜å ç”¨ | åŸºå‡† | +0.5MB (å¯å¿½ç•¥) |
| æ•°æ®åº“æŸ¥è¯¢ | 2æ¬¡ | 3æ¬¡ (+1æ¬¡è¯»å†å²) |
| ç”¨æˆ·ä½“éªŒ | â­â­â­ | â­â­â­â­â­ |

**ç»“è®º:** 
- âœ… æ€§èƒ½å½±å“å¾ˆå°ï¼ˆ+200ms æŸ¥è¯¢ + +600 tokens ç”Ÿæˆï¼‰
- âœ… ç”¨æˆ·ä½“éªŒæå‡å·¨å¤§ï¼ˆæ”¯æŒè¿ç»­å¯¹è¯ï¼‰
- âœ… Token æ¶ˆè€—å¯æ§ï¼ˆæ»‘åŠ¨çª—å£æœºåˆ¶ï¼‰

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨åç«¯æœåŠ¡

```powershell
cd C:\Users\Man\Desktop\MyRAG
.\start.bat
```

### 2. æ‰“å¼€èŠå¤©é¡µé¢

è®¿é—®: `http://localhost:8000/chat.html`

### 3. æ‰§è¡Œæµ‹è¯•åœºæ™¯

#### æµ‹è¯• Aï¼šåŸºç¡€è®°å¿†
```
ä½ : æˆ‘å«å¼ ä¸‰
AI: [å›å¤]
ä½ : æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ
AI: ä½ å«å¼ ä¸‰ âœ…
```

#### æµ‹è¯• Bï¼šå¤šè½®æ¨ç†
```
ä½ : 1+1ç­‰äºå‡ ï¼Ÿ
AI: 2
ä½ : é‚£è¿™ä¸ªæ•°å­—åŠ 3å‘¢ï¼Ÿ
AI: 5 âœ…
```

#### æµ‹è¯• Cï¼šä»£è¯æŒ‡ä»£
```
ä½ : åä¸ºæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ
AI: [ä»‹ç»åä¸º]
ä½ : å®ƒçš„åˆ›å§‹äººæ˜¯è°ï¼Ÿ
AI: åä¸ºçš„åˆ›å§‹äººæ˜¯ä»»æ­£é âœ…
```

### 4. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤

åç«¯æ—¥å¿—åº”æ˜¾ç¤º:
```
è°ƒç”¨Transformersæ¨¡å‹: DeepSeek-R1-Distill-Qwen-1.5B, å†å²æ¶ˆæ¯: 2æ¡
è°ƒç”¨Transformersæ¨¡å‹: DeepSeek-R1-Distill-Qwen-1.5B, å†å²æ¶ˆæ¯: 4æ¡
```

---

## ğŸ¯ å…³é”®å®ç°ç‚¹

### âœ… 1. å†å²æ¶ˆæ¯æŒ‰æ—¶é—´æ­£åºæ’åˆ—

```python
history_rows = cursor.fetchall()  # æŒ‰ created_at DESC
history_messages = list(reversed(history_rows))  # åè½¬ä¸ºæ­£åº
```

**åŸå› :** LLM éœ€è¦æŒ‰æ—¶é—´é¡ºåºç†è§£å¯¹è¯ï¼ˆæ—§â†’æ–°ï¼‰

---

### âœ… 2. æ’é™¤å½“å‰ç”¨æˆ·æ¶ˆæ¯

æŸ¥è¯¢å†å²æ—¶ä½¿ç”¨ `ORDER BY created_at DESC`ï¼Œè‡ªåŠ¨æ’é™¤åˆšæ’å…¥çš„å½“å‰æ¶ˆæ¯

---

### âœ… 3. RAG ä¸Šä¸‹æ–‡æ’å…¥åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯

```python
if context:
    user_message = f"""åŸºäºä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”é—®é¢˜...

ä¸Šä¸‹æ–‡ï¼š
{context}

é—®é¢˜ï¼š{query}
"""
else:
    user_message = query

# æ’å…¥åˆ° messages æœ«å°¾
messages.append({"role": "user", "content": user_message})
```

---

### âœ… 4. æµå¼å’Œéæµå¼ä½¿ç”¨ç›¸åŒé€»è¾‘

`chat_with_assistant()` å’Œ `chat_with_assistant_stream()` éƒ½å®ç°äº†ç›¸åŒçš„å†å²æ¶ˆæ¯è¯»å–å’Œä¼ é€’é€»è¾‘

---

## ğŸ‰ æ€»ç»“

### ä¿®æ”¹æ–‡ä»¶æ¸…å•
1. âœ… `Backend/app/api/conversation.py` - æ·»åŠ  `max_history_turns` å‚æ•°ï¼Œè¯»å–å†å²æ¶ˆæ¯
2. âœ… `Backend/app/services/chat_service.py` - æ”¯æŒ `history_messages` å‚æ•°ï¼Œæ„å»ºå®Œæ•´å¯¹è¯

### æ ¸å¿ƒåŠŸèƒ½
- âœ… æ»‘åŠ¨çª—å£ä¸Šä¸‹æ–‡è®°å¿†ï¼ˆé»˜è®¤ 10 è½®ï¼‰
- âœ… æ”¯æŒæµå¼å’Œéæµå¼
- âœ… æ”¯æŒçº¯å¯¹è¯å’Œ RAG æ¨¡å¼
- âœ… Token æ¶ˆè€—å¯æ§

### ä¸‹ä¸€æ­¥
1. é‡å¯åç«¯æœåŠ¡
2. æ‰§è¡Œæµ‹è¯•åœºæ™¯
3. æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´ `max_history_turns` å‚æ•°

---

**ç°åœ¨å¯ä»¥å¼€å§‹æµ‹è¯•ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½äº†ï¼** ğŸš€
