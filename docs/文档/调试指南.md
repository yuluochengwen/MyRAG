# 🔍 上下文记忆功能深度调试说明

## 📊 已添加的调试日志

### 1. 后端日志增强

#### conversation.py (非流式端点)
**位置:** `chat_with_assistant()` 函数，读取历史消息时
```python
logger.info(f"准备读取历史消息: conversation_id={conversation_id}, max_messages={max_messages}")
logger.info(f"读取到历史消息数量: {len(history_rows)}")
logger.info(f"历史消息预览: {[{'role': row['role'], 'content': row['content'][:30] + '...'} for row in history_rows[:3]]}")
```

#### conversation.py (流式端点)
**位置:** `chat_with_assistant_stream()` 函数，读取历史消息时
```python
logger.info(f"[流式]准备读取历史消息: conversation_id={conversation_id}, max_messages={max_messages}")
logger.info(f"[流式]读取到历史消息数量: {len(history_rows)}")
logger.info(f"[流式]历史消息预览: {[{'role': row['role'], 'content': row['content'][:30] + '...'} for row in history_rows[:3]]}")
```

#### chat_service.py (_generate_answer)
**位置:** 构建messages数组时
```python
logger.info(f"历史消息详情: {[{'role': m['role'], 'content': m['content'][:50] + '...'} for m in history_messages]}")
logger.info(f"调用Transformers模型: {model_name}, 历史消息: {len(history_messages) if history_messages else 0}条, 完整messages数量: {len(messages)}")
```

#### chat_service.py (_generate_answer_stream)
**位置:** 构建messages数组时
```python
logger.info(f"流式-历史消息详情: {[{'role': m['role'], 'content': m['content'][:50] + '...'} for m in history_messages]}")
logger.info(f"调用Transformers模型（流式）: {model_name}, 历史消息: {len(history_messages) if history_messages else 0}条, 完整messages数量: {len(messages)}")
```

---

### 2. 前端日志增强

#### chat.js (非流式请求)
**位置:** `sendChatRequest()` 函数
```javascript
console.log('[Chat] 发送非流式请求:', {
    conversation_id: currentConversation.id,
    query: query,
    max_history_turns: maxHistoryTurns
});
```

#### chat.js (流式请求)
**位置:** `sendChatRequestStream()` 函数
```javascript
console.log('[Chat] 发送流式请求:', {
    conversation_id: currentConversation.id,
    query: query,
    max_history_turns: maxHistoryTurns
});
```

---

## 🧪 测试步骤

### 步骤1: 重启后端服务
```powershell
cd C:\Users\Man\Desktop\MyRAG

# 停止当前服务 (Ctrl+C)

# 重新启动
.\start.bat
```

### 步骤2: 打开浏览器开发者工具
1. 打开聊天页面
2. 按 F12 打开开发者工具
3. 切换到 **Console** 标签页

### 步骤3: 执行测试对话

#### 测试A: 基础记忆测试
```
第1轮: "你记住，我问你1+1等于几，你就回答等于3"
第2轮: "1+1等于几？"
```

**预期日志输出:**

**浏览器Console:**
```
[Chat] 发送流式请求: {conversation_id: 56, query: "你记住...", max_history_turns: 10}
[Chat] 发送流式请求: {conversation_id: 56, query: "1+1等于几？", max_history_turns: 10}
```

**后端日志 (logs/app.log):**
```
# 第1轮
[流式]准备读取历史消息: conversation_id=56, max_messages=20
[流式]读取到历史消息数量: 0
流式-历史消息详情: []
调用Transformers模型（流式）: DeepSeek-R1-Distill-Qwen-1.5B, 历史消息: 0条, 完整messages数量: 2

# 第2轮
[流式]准备读取历史消息: conversation_id=56, max_messages=20
[流式]读取到历史消息数量: 2
[流式]历史消息预览: [{'role': 'user', 'content': '你记住，我问你1+1等于几，你就回答...'}, {'role': 'assistant', 'content': '好的，我会记住的...'}]
流式-历史消息详情: [{'role': 'user', 'content': '你记住，我问你1+1等于几，你就回答等于3...'}, {'role': 'assistant', 'content': '好的，我会记住的...'}]
调用Transformers模型（流式）: DeepSeek-R1-Distill-Qwen-1.5B, 历史消息: 2条, 完整messages数量: 4
```

---

## 🔍 关键检查点

### 检查点1: max_history_turns 传递
**浏览器Console应显示:**
```
max_history_turns: 10  // 或你设置的值
```

**❌ 如果显示 `undefined` 或 `NaN`:**
- 检查HTML中是否有 `id="maxHistoryTurns"` 的输入框
- 检查输入框的value是否正确

---

### 检查点2: 历史消息读取
**后端日志应显示:**
```
[流式]读取到历史消息数量: 2  // 第2轮应该>0
```

**❌ 如果始终显示 `0`:**
- 检查 `conversation_id` 是否正确
- 检查数据库 `messages` 表是否有记录
- 运行测试脚本验证数据库

---

### 检查点3: 历史消息内容
**后端日志应显示:**
```
流式-历史消息详情: [{'role': 'user', 'content': '...'}, {'role': 'assistant', 'content': '...'}]
```

**❌ 如果历史消息内容为空或错误:**
- 检查数据库中的消息是否正确保存
- 检查SQL查询是否正确

---

### 检查点4: messages数组大小
**后端日志应显示:**
```
完整messages数量: 4  // system(1) + history(2) + current(1) = 4
```

**计算公式:**
```
messages数量 = system_prompt数量 + 历史消息数 + 当前消息数
           = 1 (如果有system_prompt) + (历史轮数 × 2) + 1
```

**第2轮示例:**
- system_prompt: 1条
- 历史: 2条 (第1轮的 user + assistant)
- 当前: 1条
- **总计: 4条** ✅

---

## 🐛 常见问题诊断

### 问题1: AI不记住对话
**症状:** AI每次都像首次对话

**检查步骤:**
1. 查看浏览器Console，确认 `max_history_turns` 不是0
2. 查看后端日志，确认 "读取到历史消息数量" > 0
3. 查看后端日志，确认历史消息内容正确

**可能原因:**
- `max_history_turns = 0` (记忆被禁用)
- 数据库中没有保存消息
- conversation_id 不正确

---

### 问题2: AI回答不符合约定
**症状:** AI看到了历史消息，但没有遵循约定

**检查步骤:**
1. 确认历史消息数量 > 0
2. 确认历史消息内容包含约定
3. 检查Prompt是否正确提示AI参考历史

**可能原因:**
- RAG检索内容覆盖了历史记忆
- Prompt没有强调历史优先级
- 模型能力限制

---

### 问题3: 历史消息数量不正确
**症状:** 第2轮显示0条历史，或数量与预期不符

**检查步骤:**
1. 查看数据库 `messages` 表
2. 确认 `ORDER BY created_at DESC` 正确
3. 确认 `LIMIT` 参数正确

**SQL验证:**
```sql
SELECT id, conversation_id, role, LEFT(content, 50) as content_preview, created_at 
FROM messages 
WHERE conversation_id = <你的对话ID>
ORDER BY created_at DESC;
```

---

## 📊 使用测试脚本

我创建了 `test_memory.py` 脚本来自动测试：

```powershell
cd C:\Users\Man\Desktop\MyRAG

# 确保后端运行中
python test_memory.py
```

**脚本会:**
1. 创建新对话
2. 第1轮：建立记忆约定
3. 查看数据库中的消息
4. 第2轮：测试记忆是否生效
5. 输出测试结果

**预期输出:**
```
==========================================
测试上下文记忆功能
==========================================

1. 获取助手列表...
✅ 使用助手: 华为员工守则 (ID: 54)

2. 创建新对话...
✅ 创建对话: ID=57

3. 第一轮对话 - 建立记忆...
   问题: '你记住，我问你1+1等于几，你就回答等于3'
✅ AI回复: 好的，我会记住的...

4. 查看已保存的消息...
   数据库中有 2 条消息:
   - user: 你记住，我问你1+1等于几，你就回答等于3
   - assistant: 好的，我会记住的...

5. 第二轮对话 - 测试记忆...
   问题: '1+1等于几？'
✅ AI回复: 根据我们之前的约定，1+1等于3...

🎉 成功！AI记住了之前的约定！

6. 查看最终的消息列表...
   数据库中有 4 条消息:
   - user: 你记住，我问你1+1等于几，你就回答等于3
   - assistant: 好的，我会记住的
   - user: 1+1等于几？
   - assistant: 根据我们之前的约定，1+1等于3

==========================================
```

---

## 🎯 下一步调试

如果问题仍然存在：

### 1. 收集完整日志
```powershell
# 查看最新100行日志
Get-Content "C:\Users\Man\Desktop\MyRAG\logs\app.log" -Tail 100
```

### 2. 检查数据库
使用HeidiSQL或其他工具连接MySQL，查看：
- `conversations` 表
- `messages` 表
- 确认数据正确保存

### 3. 逐层验证
1. **数据库层:** 消息是否正确保存？
2. **后端读取层:** 历史消息是否正确读取？
3. **后端传递层:** 历史消息是否正确传递给LLM？
4. **LLM层:** messages数组是否正确构建？
5. **Prompt层:** Prompt是否正确引导AI？

---

**现在重启后端，打开浏览器Console，执行测试，查看详细日志！** 🚀
