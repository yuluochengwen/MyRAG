# Backend重构依赖关系可视化图

```mermaid
graph TD
    %% 阶段定义
    S0[阶段0: 准备<br/>Week 0 - 3天<br/>测试基准、环境准备]
    S1[阶段1: 基础层<br/>Week 1-2 - 10天<br/>DeviceManager、ModelLoader]
    S2[阶段2: 模型层<br/>Week 3-5 - 17天<br/>LLM抽象、Transformers拆分]
    S3[阶段3: 业务层<br/>Week 6-8 - 20天<br/>检索策略、知识库重构]
    S4[阶段4: 应用层<br/>Week 9-10 - 8天<br/>RAG Pipeline、Agent]
    S5[阶段5: 迁移与清理<br/>Week 11-12 - 8天<br/>API迁移、删除旧代码]

    %% 依赖关系
    S0 -.软依赖.-> S1
    S1 ==强依赖==> S2
    S1 -.间接依赖.-> S3
    S2 ==强依赖==> S3
    S1 -.间接依赖.-> S4
    S2 -.间接依赖.-> S4
    S3 ==强依赖==> S4
    S4 ==强依赖+顺序==> S5

    %% 样式
    classDef phase0 fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    classDef phase1 fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef phase2 fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef phase3 fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef phase4 fill:#fce4ec,stroke:#e91e63,stroke-width:2px
    classDef phase5 fill:#ffebee,stroke:#f44336,stroke-width:3px

    class S0 phase0
    class S1 phase1
    class S2 phase2
    class S3 phase3
    class S4 phase4
    class S5 phase5

    %% 说明
    S0 -.-> Note1[✅ 无强依赖<br/>可独立开始]
    S2 -.-> Note2[⚠️ 强依赖阶段1<br/>ConfigManager需要DeviceManager]
    S4 -.-> Note3[⚠️ 强依赖阶段3<br/>RAGPipeline需要RetrieverManager]
    S5 -.-> Note4[🔴 极高风险<br/>必须先迁移再删除<br/>Week 11迁移 → Week 12删除]

    style Note1 fill:#d4edda,stroke:#28a745
    style Note2 fill:#fff3cd,stroke:#ffc107
    style Note3 fill:#fff3cd,stroke:#ffc107
    style Note4 fill:#f8d7da,stroke:#dc3545
```

![image-20251124223040322](C:\Users\Man\AppData\Roaming\Typora\typora-user-images\image-20251124223040322.png)

## 依赖关系详细说明

### 图例说明

- **实线箭头（==强依赖==>）**: 必须等待前置阶段完成，无法并行
- **虚线箭头（-.间接依赖.->）**: 通过中间层间接依赖，可部分并行
- **点线箭头（-.软依赖.->）**: 可选依赖，不阻塞开发

### 关键路径（Critical Path）

```
阶段0 → 阶段1 → 阶段2 → 阶段3 → 阶段4 → 阶段5
  3天     10天     17天     20天     8天     8天

总计: 66天（约13周）
```

### 并行开发机会

```mermaid
gantt
    title Backend重构时间线（含并行优化）
    dateFormat YYYY-MM-DD
    section 准备
    阶段0 准备           :s0, 2025-01-27, 3d
    section 基础层
    阶段1 基础层         :s1, after s0, 10d
    section 模型层
    阶段2 模型层         :s2, after s1, 17d
    section 业务层
    阶段3 业务层（Mock） :crit, s3a, after s2, 14d
    阶段3 业务层（整合） :s3b, after s3a, 6d
    section 应用层
    阶段4 应用层（Mock） :crit, s4a, 2025-03-10, 5d
    阶段4 应用层（整合） :s4b, after s3b, 3d
    section 清理
    阶段5 Week11迁移    :crit, s5a, after s4b, 5d
    阶段5 Week12清理    :s5b, after s5a, 3d
```

### 风险热力图

```mermaid
graph LR
    subgraph 风险等级
        R1[✅ 低风险<br/>阶段0→1]
        R2[⚠️ 中风险<br/>阶段1→2]
        R3[⚠️ 高风险<br/>阶段3→4]
        R4[🔴 极高风险<br/>阶段4→5]
    end

    style R1 fill:#d4edda,stroke:#28a745
    style R2 fill:#fff3cd,stroke:#ffc107
    style R3 fill:#ffe5b4,stroke:#ff9800
    style R4 fill:#f8d7da,stroke:#dc3545
```

## 依赖矩阵（行依赖列）

|        | 阶段0 | 阶段1 | 阶段2 | 阶段3 | 阶段4 | 阶段5 |
|--------|-------|-------|-------|-------|-------|-------|
| 阶段0  | -     | ❌    | ❌    | ❌    | ❌    | ❌    |
| 阶段1  | ✅    | -     | ❌    | ❌    | ❌    | ❌    |
| 阶段2  | ❌    | ✅    | -     | ❌    | ❌    | ❌    |
| 阶段3  | ❌    | ✅    | ✅    | -     | ❌    | ❌    |
| 阶段4  | ❌    | ✅    | ✅    | ✅    | -     | ❌    |
| 阶段5  | ❌    | ✅    | ✅    | ✅    | ✅    | -     |

**✅ = 有依赖 | ❌ = 无依赖 | - = 自身**

**结论**: ✅ **无循环依赖**，依赖关系为单向流（DAG有向无环图）

## 核心组件依赖图

```mermaid
graph TD
    subgraph 阶段1输出
        DM[DeviceManager]
        ML[ModelLoader]
        Utils[工具类集合]
    end

    subgraph 阶段2输出
        BaseLLM[BaseLLM接口]
        Embed[EmbeddingService]
        TLLM[TransformersLLM]
    end

    subgraph 阶段3输出
        RM[RetrieverManager]
        KBS[KnowledgeBaseService]
    end

    subgraph 阶段4输出
        RAG[RAGPipeline]
        Chat[ChatService]
    end

    %% 阶段1 → 阶段2
    DM --> |设备管理| TLLM
    DM --> |量化配置| ConfigMgr[ConfigManager]
    ML --> |模型加载| TLLM
    ConfigMgr --> TLLM

    %% 阶段2 → 阶段3
    Embed --> |向量化| VectorRetriever[VectorRetriever]
    VectorRetriever --> RM

    %% 阶段3 → 阶段4
    RM --> |检索文档| RAG
    BaseLLM --> |生成回复| RAG
    RAG --> |RAG流程| Chat

    %% 样式
    classDef stage1 fill:#e3f2fd,stroke:#2196f3
    classDef stage2 fill:#fff3e0,stroke:#ff9800
    classDef stage3 fill:#f3e5f5,stroke:#9c27b0
    classDef stage4 fill:#fce4ec,stroke:#e91e63

    class DM,ML,Utils stage1
    class BaseLLM,Embed,TLLM,ConfigMgr stage2
    class RM,KBS,VectorRetriever stage3
    class RAG,Chat stage4
```

## 关键检查点

### 🔍 阶段1完成前
- [ ] DeviceManager接口完整性测试
- [ ] ModelLoader单元测试覆盖率>80%
- [ ] Mock对象提供（给阶段2使用）

### 🔍 阶段2完成前
- [ ] BaseLLM接口冻结
- [ ] EmbeddingService统一接口测试
- [ ] Mock EmbeddingService提供

### 🔍 阶段3完成前
- [ ] RetrieverManager性能测试（QPS>100）
- [ ] 检索接口冻结
- [ ] Mock RetrieverManager提供

### 🔍 阶段4完成前
- [ ] RAGPipeline集成测试通过
- [ ] 所有API端点测试通过

### 🔴 阶段5完成前（极高风险）
- [ ] ✅ Week 11迁移任务全部完成
- [ ] ✅ 全局搜索确认无旧服务引用
- [ ] ✅ 创建回滚点（Git tag）
- [ ] Week 12才能执行删除操作

---

**图表维护**: 如有架构调整，请同步更新此文档和`依赖关系分析报告.md`
