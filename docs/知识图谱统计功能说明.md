# 知识图谱统计功能实现说明

## 功能概述

在知识库管理页面的知识库卡片上添加了知识图谱统计信息，用户可以：
1. 在卡片上直接看到图谱的节点数和关系数
2. 点击图谱统计标签查看详细的图谱信息，包括实体类型分布

## 实现内容

### 1. 后端API修改

#### 1.1 Schema更新 (`Backend/app/models/schemas.py`)
- 在 `KnowledgeBaseResponse` 中添加了 `graph_stats` 字段
- 修改 `from_model` 方法支持传入图谱统计数据

#### 1.2 API端点更新 (`Backend/app/api/knowledge_base.py`)

**修改的端点：**
- `GET /api/knowledge-bases` - 知识库列表现在包含每个知识库的图谱统计
- `GET /api/knowledge-bases/{kb_id}` - 单个知识库详情包含图谱统计

**新增的端点：**
- `GET /api/knowledge-bases/{kb_id}/graph/stats` - 获取指定知识库的图谱统计详情

返回格式示例：
```json
{
  "kb_id": 40,
  "kb_name": "蟹堡王助手",
  "stats": {
    "node_count": 42,
    "edge_count": 32,
    "entity_types": {
      "Product": 34,
      "Concept": 7,
      "Date": 1
    }
  }
}
```

### 2. 前端修改

#### 2.1 HTML结构 (`Frontend/knowledge-base.html`)
- 添加了知识图谱详情模态框 `#graphModal`
- 模态框包含：
  - 标题和知识库名称
  - 图谱统计内容区域
  - 关闭按钮

#### 2.2 JavaScript功能 (`Frontend/js/knowledge-base.js`)

**新增函数：**

1. `renderGraphStats(kb)` - 渲染图谱统计标签
   - 如果有图谱数据，显示紫色标签："N 节点 / M 关系"
   - 点击可查看详情
   - 如果没有数据，不显示

2. `viewGraph(kbId, event)` - 查看图谱详情
   - 调用 `/api/knowledge-bases/{kb_id}/graph/stats` 获取数据
   - 显示节点数和关系数的概览卡片（紫色和蓝色）
   - 展示实体类型分布列表
   - 提供Neo4j Browser访问链接

3. `closeGraphModal()` - 关闭图谱模态框

**UI样式：**
- 图谱统计标签使用紫色主题 (`bg-purple-50 text-purple-600`)
- 与文件统计（蓝色）和文本块统计（绿色）风格一致
- 支持hover效果和点击交互

### 3. 辅助脚本

#### 3.1 测试脚本 (`test_graph_api.py`)
- 测试知识库列表API是否正确返回图谱统计
- 测试单个知识库的图谱统计API

#### 3.2 构建脚本 (`build_graph.py`)
- 用于为指定知识库构建知识图谱
- 使用方法：`python build_graph.py <kb_id>`
- 显示构建进度和结果统计

## 使用方法

### 查看图谱统计

1. 打开知识库管理页面：http://localhost:8000/knowledge-base.html
2. 在知识库卡片上可以看到图谱统计标签（如果有图谱数据）
3. 点击紫色的图谱统计标签查看详细信息

### 构建知识图谱

如果知识库还没有图谱数据，可以使用以下命令构建：

```bash
# 激活虚拟环境
conda activate MyRAG

# 构建指定知识库的图谱
python build_graph.py <知识库ID>

# 例如：
python build_graph.py 40
```

**注意事项：**
1. 知识库必须已经有文档和文本块
2. 需要Neo4j服务运行（bolt://localhost:7687）
3. 需要Ollama服务运行，并加载了 `deepseek-v3.1:671b-cloud` 模型
4. 构建过程可能需要几分钟，取决于文本块数量

## 技术细节

### 图谱数据流程

1. 文档上传 → 文本分割 → 生成文本块
2. 构建图谱（手动触发或自动）：
   - 从文本块提取实体和关系（使用Ollama LLM）
   - 导入到Neo4j图数据库
3. 查询统计：
   - 通过Neo4j查询获取节点数、关系数
   - 统计实体类型分布
4. 前端展示

### API性能考虑

- 知识库列表API会为每个知识库查询图谱统计
- 如果Neo4j不可用，会返回 `null` 而不是报错
- 图谱统计查询使用了Neo4j的高效Cypher查询

## 测试结果

### 测试环境
- 后端服务：http://localhost:8000
- Neo4j服务：bolt://localhost:7687
- 测试知识库：#40 "蟹堡王助手"

### 测试数据
- 文件数：1
- 文本块数：4
- 图谱节点数：42
- 图谱关系数：32
- 实体类型：Product (34), Concept (7), Date (1)

### 验证结果
✅ API返回正确的图谱统计
✅ 前端正确显示图谱标签
✅ 点击标签可查看详情
✅ 模态框正确显示统计信息和实体类型分布
✅ 无数据时不显示图谱标签

## 可视化图谱

如需查看完整的图谱可视化，可访问Neo4j Browser：
- URL: http://localhost:7474
- 用户名: neo4j
- 密码: myrag123

示例Cypher查询：
```cypher
// 查看指定知识库的所有节点和关系
MATCH (n:Entity {kb_id: 40})-[r:RELATION]->(m:Entity)
RETURN n, r, m
LIMIT 100

// 查看实体类型分布
MATCH (n:Entity {kb_id: 40})
RETURN n.type as entity_type, count(n) as count
ORDER BY count DESC
```

## 后续优化建议

1. **自动构建图谱**
   - 在文档上传完成后自动触发图谱构建
   - 在后台任务中异步处理

2. **增量更新**
   - 支持只为新增文档构建图谱
   - 避免每次都全量重建

3. **前端可视化**
   - 集成图谱可视化库（如D3.js、vis.js）
   - 在模态框中直接展示图谱结构

4. **图谱管理**
   - 添加重建图谱按钮
   - 添加删除图谱按钮
   - 显示图谱构建状态和进度

5. **性能优化**
   - 对大型知识库使用缓存
   - 分页加载图谱数据
   - 优化Neo4j查询性能
